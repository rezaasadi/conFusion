define(["./core","./var/slice","./callbacks"],function(e,t){"use strict";function n(e){return e}function r(e){throw e}function i(t,n,r){var i;try{t&&e.isFunction(i=t.promise)?i.call(t).done(n).fail(r):t&&e.isFunction(i=t.then)?i.call(t,n,r):n.call(void 0,t)}catch(t){r.call(void 0,t)}}return e.extend({Deferred:function(t){var i=[["notify","progress",e.Callbacks("memory"),e.Callbacks("memory"),2],["resolve","done",e.Callbacks("once memory"),e.Callbacks("once memory"),0,"resolved"],["reject","fail",e.Callbacks("once memory"),e.Callbacks("once memory"),1,"rejected"]],o="pending",s={state:function(){return o},always:function(){return a.done(arguments).fail(arguments),this},"catch":function(e){return s.then(null,e)},pipe:function(){var t=arguments;return e.Deferred(function(n){e.each(i,function(r,i){var o=e.isFunction(t[i[4]])&&t[i[4]];a[i[1]](function(){var t=o&&o.apply(this,arguments);t&&e.isFunction(t.promise)?t.promise().progress(n.notify).done(n.resolve).fail(n.reject):n[i[0]+"With"](this,o?[t]:arguments)})}),t=null}).promise()},then:function(t,o,s){function u(t,i,o,s){return function(){var l=this,c=arguments,f=function(){var f,h;if(!(a>t)){if(f=o.apply(l,c),f===i.promise())throw new TypeError("Thenable self-resolution");h=f&&("object"==typeof f||"function"==typeof f)&&f.then,e.isFunction(h)?s?h.call(f,u(a,i,n,s),u(a,i,r,s)):(a++,h.call(f,u(a,i,n,s),u(a,i,r,s),u(a,i,n,i.notifyWith))):(o!==n&&(l=void 0,c=[f]),(s||i.resolveWith)(l,c))}},h=s?f:function(){try{f()}catch(n){e.Deferred.exceptionHook&&e.Deferred.exceptionHook(n,h.stackTrace),t+1>=a&&(o!==r&&(l=void 0,c=[n]),i.rejectWith(l,c))}};t?h():(e.Deferred.getStackHook&&(h.stackTrace=e.Deferred.getStackHook()),window.setTimeout(h))}}var a=0;return e.Deferred(function(a){i[0][3].add(u(0,a,e.isFunction(s)?s:n,a.notifyWith)),i[1][3].add(u(0,a,e.isFunction(t)?t:n)),i[2][3].add(u(0,a,e.isFunction(o)?o:r))}).promise()},promise:function(t){return null!=t?e.extend(t,s):s}},a={};return e.each(i,function(e,t){var n=t[2],r=t[5];s[t[1]]=n.add,r&&n.add(function(){o=r},i[3-e][2].disable,i[0][2].lock),n.add(t[3].fire),a[t[0]]=function(){return a[t[0]+"With"](this===a?void 0:this,arguments),this},a[t[0]+"With"]=n.fireWith}),s.promise(a),t&&t.call(a,a),a},when:function(n){var r=arguments.length,o=r,s=Array(o),a=t.call(arguments),u=e.Deferred(),l=function(e){return function(n){s[e]=this,a[e]=arguments.length>1?t.call(arguments):n,--r||u.resolveWith(s,a)}};if(1>=r&&(i(n,u.done(l(o)).resolve,u.reject),"pending"===u.state()||e.isFunction(a[o]&&a[o].then)))return u.then();for(;o--;)i(a[o],l(o),u.reject);return u.promise()}}),e});
